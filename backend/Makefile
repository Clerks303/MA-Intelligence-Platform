# M&A Intelligence Platform - ML Scoring Makefile
# Commandes pour orchestrer le scoring ML

.PHONY: help install score-all score-recent score-debug score-companies score-test train-models status logs clean

# Configuration
PYTHON := python3
VENV := venv
SCRIPT := scoring.py
LOG_FILE := scoring.log

# Couleurs pour l'affichage
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## Affiche cette aide
	@echo "$(GREEN)M&A Intelligence Platform - ML Scoring$(NC)"
	@echo "$(YELLOW)Commandes disponibles:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

install: ## Installe les dÃ©pendances ML
	@echo "$(YELLOW)ğŸ“¦ Installation des dÃ©pendances ML...$(NC)"
	$(PYTHON) -m pip install --upgrade pip
	$(PYTHON) -m pip install -r requirements-ml.txt
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

check-env: ## VÃ©rifie la configuration
	@echo "$(YELLOW)ğŸ” VÃ©rification de l'environnement...$(NC)"
	@if [ -z "$$SUPABASE_URL" ]; then echo "$(RED)âŒ SUPABASE_URL manquant$(NC)"; exit 1; fi
	@if [ -z "$$SUPABASE_KEY" ]; then echo "$(RED)âŒ SUPABASE_KEY manquant$(NC)"; exit 1; fi
	@echo "$(GREEN)âœ… Configuration OK$(NC)"

score-all: check-env ## Lance le scoring pour toutes les entreprises
	@echo "$(YELLOW)ğŸš€ DÃ©marrage scoring complet...$(NC)"
	$(PYTHON) $(SCRIPT) --log-level INFO
	@echo "$(GREEN)âœ… Scoring terminÃ©$(NC)"

score-recent: check-env ## Score uniquement les entreprises rÃ©centes (derniers 30 jours)
	@echo "$(YELLOW)ğŸ“… Scoring des entreprises rÃ©centes...$(NC)"
	$(PYTHON) $(SCRIPT) --batch-size 500 --log-level INFO
	@echo "$(GREEN)âœ… Scoring rÃ©cent terminÃ©$(NC)"

score-debug: check-env ## Lance le scoring en mode debug
	@echo "$(YELLOW)ğŸ› Scoring en mode debug...$(NC)"
	$(PYTHON) $(SCRIPT) --batch-size 10 --log-level DEBUG

score-companies: check-env ## Score des entreprises spÃ©cifiques (usage: make score-companies IDS="1,2,3")
	@if [ -z "$(IDS)" ]; then echo "$(RED)âŒ Usage: make score-companies IDS=\"1,2,3\"$(NC)"; exit 1; fi
	@echo "$(YELLOW)ğŸ¯ Scoring entreprises: $(IDS)$(NC)"
	$(PYTHON) $(SCRIPT) --company-ids $(IDS) --log-level INFO

score-test: check-env ## Lance un scoring de test sur 5 entreprises
	@echo "$(YELLOW)ğŸ§ª Test scoring (5 entreprises)...$(NC)"
	$(PYTHON) $(SCRIPT) --batch-size 5 --log-level DEBUG

train-models: check-env ## Force le rÃ©-entraÃ®nement des modÃ¨les
	@echo "$(YELLOW)ğŸ§  RÃ©-entraÃ®nement des modÃ¨les ML...$(NC)"
	$(PYTHON) $(SCRIPT) --force-retrain --batch-size 100 --log-level INFO
	@echo "$(GREEN)âœ… ModÃ¨les rÃ©-entraÃ®nÃ©s$(NC)"

status: ## Affiche le statut des derniers scorings
	@echo "$(YELLOW)ğŸ“Š Statut des scorings...$(NC)"
	@if [ -f $(LOG_FILE) ]; then \
		echo "$(GREEN)DerniÃ¨res lignes du log:$(NC)"; \
		tail -n 10 $(LOG_FILE); \
	else \
		echo "$(RED)âŒ Aucun log trouvÃ©$(NC)"; \
	fi

logs: ## Affiche les logs en temps rÃ©el
	@echo "$(YELLOW)ğŸ“‹ Logs en temps rÃ©el (Ctrl+C pour arrÃªter)...$(NC)"
	@if [ -f $(LOG_FILE) ]; then \
		tail -f $(LOG_FILE); \
	else \
		echo "$(RED)âŒ Aucun log trouvÃ©$(NC)"; \
	fi

clean: ## Nettoie les fichiers temporaires
	@echo "$(YELLOW)ğŸ§¹ Nettoyage...$(NC)"
	find . -name "*.pyc" -delete
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

clean-models: ## Supprime les modÃ¨les sauvegardÃ©s (force rÃ©-entraÃ®nement)
	@echo "$(YELLOW)ğŸ—‘ï¸ Suppression des modÃ¨les...$(NC)"
	rm -f *.joblib
	@echo "$(GREEN)âœ… ModÃ¨les supprimÃ©s$(NC)"

backup-models: ## Sauvegarde les modÃ¨les avec timestamp
	@echo "$(YELLOW)ğŸ’¾ Sauvegarde des modÃ¨les...$(NC)"
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	mkdir -p backups; \
	if ls *.joblib 1> /dev/null 2>&1; then \
		tar -czf backups/models_$$timestamp.tar.gz *.joblib; \
		echo "$(GREEN)âœ… ModÃ¨les sauvegardÃ©s: backups/models_$$timestamp.tar.gz$(NC)"; \
	else \
		echo "$(RED)âŒ Aucun modÃ¨le Ã  sauvegarder$(NC)"; \
	fi

monitor: ## Lance un monitoring continu (refresh toutes les 30s)
	@echo "$(YELLOW)ğŸ‘ï¸ Monitoring continu (Ctrl+C pour arrÃªter)...$(NC)"
	@while true; do \
		clear; \
		echo "$(GREEN)=== M&A Intelligence - Monitoring ML ===$(NC)"; \
		echo "$(YELLOW)Timestamp: $$(date)$(NC)"; \
		echo ""; \
		if [ -f $(LOG_FILE) ]; then \
			echo "$(GREEN)DerniÃ¨res activitÃ©s:$(NC)"; \
			tail -n 5 $(LOG_FILE) | sed 's/^/  /'; \
		fi; \
		echo ""; \
		echo "$(GREEN)ModÃ¨les disponibles:$(NC)"; \
		ls -la *.joblib 2>/dev/null | sed 's/^/  /' || echo "  $(RED)Aucun modÃ¨le trouvÃ©$(NC)"; \
		echo ""; \
		echo "$(YELLOW)Prochain refresh dans 30s...$(NC)"; \
		sleep 30; \
	done

# Commandes de dÃ©ploiement
deploy-cron: ## Configure un cron job quotidien
	@echo "$(YELLOW)â° Configuration cron job...$(NC)"
	@cron_entry="0 2 * * * cd $$(pwd) && make score-all >> /var/log/ma-intelligence-scoring.log 2>&1"; \
	(crontab -l 2>/dev/null | grep -v "ma-intelligence-scoring"; echo "$$cron_entry") | crontab -
	@echo "$(GREEN)âœ… Cron job configurÃ© (tous les jours Ã  2h)$(NC)"

remove-cron: ## Supprime le cron job
	@echo "$(YELLOW)ğŸ—‘ï¸ Suppression cron job...$(NC)"
	@crontab -l 2>/dev/null | grep -v "ma-intelligence-scoring" | crontab -
	@echo "$(GREEN)âœ… Cron job supprimÃ©$(NC)"

# Commandes d'environnement
setup-env: ## Configure l'environnement complet
	@echo "$(YELLOW)ğŸ”§ Configuration environnement...$(NC)"
	cp .env.example .env 2>/dev/null || echo "$(YELLOW)âš ï¸ CrÃ©ez le fichier .env manuellement$(NC)"
	$(MAKE) install
	@echo "$(GREEN)âœ… Environnement configurÃ©$(NC)"

# Commandes d'analyse
analyze-scores: ## Analyse les scores en base
	@echo "$(YELLOW)ğŸ“Š Analyse des scores...$(NC)"
	$(PYTHON) -c "
import pandas as pd
from supabase import create_client
import os
from dotenv import load_dotenv

load_dotenv()
supabase = create_client(os.getenv('SUPABASE_URL'), os.getenv('SUPABASE_KEY'))

try:
    result = supabase.table('ml_scores').select('*').execute()
    if result.data:
        df = pd.DataFrame(result.data)
        print(f'ğŸ“ˆ Total scores: {len(df)}')
        print(f'ğŸ“Š Score composite moyen: {df[\"score_composite\"].mean():.1f}')
        print(f'âœ… Confiance moyenne: {df[\"confidence\"].mean():.1f}%')
        print(f'ğŸ“… Dernier calcul: {df[\"calculated_at\"].max()}')
    else:
        print('âŒ Aucun score trouvÃ©')
except Exception as e:
    print(f'âŒ Erreur: {e}')
"

# RÃ¨gle par dÃ©faut
.DEFAULT_GOAL := help